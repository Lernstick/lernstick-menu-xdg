#!/bin/sh

if [ ! -e /etc/polkit-1/localauthority/50-local.d/10-welcome.pkla ] &&
   [ ! -e /etc/polkit-1/localauthority/55-lernstick-exam.d/10-welcome_strict.pkla ] &&
   ! grep -q ShowPasswordDialog=false /etc/lernstickWelcome
then
        # as long as the user didn't set a password we allow everything...
	echo "The user didn't set a passwort yet. Exiting..."
        exit 0
fi

# gettext support
. gettext.sh
export TEXTDOMAIN=detect_virtualization

VIRTUALIZATION="$(systemd-detect-virt)"
if [ "${VIRTUALIZATION}" = "none" ]
then
	echo "No virtualization detected."
        exit 0
fi

echo "Virtualization \"${VIRTUALIZATION}\" detected."

TMP_FILE="/tmp/virtualization_lock.jpg"
convert /usr/share/backgrounds/gnome/Wood.jpg \
	-background black \
	-fill white \
	-pointsize 90 \
	-gravity South \
	-splice 0x220 \
	-annotate +0+20 "$(eval_gettext "Virtualization (\${VIRTUALIZATION}) detected\nLogin required")" \
	-append \
	"${TMP_FILE}"

dconf write /org/gnome/desktop/screensaver/picture-uri "'file://${TMP_FILE}'"
dconf write /org/gnome/desktop/screensaver/picture-options "'stretched'"

# In Debian 10 XDG autostart applications are started too early, see:
# https://blogs.gnome.org/benzea/2019/10/01/gnome-3-34-is-now-managed-using-systemd/#comment-14161
# Therefore we have to use the following tight loop to close any "window of opportunity" for aspiring exam hackers.

# Unfortunately, we have to wait a little bit. Otherwise we just crash GNOME...
sleep 3

while
	echo "Trying to lock screen..."
	dbus-send --type=method_call --dest=org.gnome.ScreenSaver /org/gnome/ScreenSaver org.gnome.ScreenSaver.Lock
	sleep 0.5
	echo "Checking if screen is now locked..."
	DBUS_REPLY="$(dbus-send --session --print-reply=literal --type=method_call --dest='org.gnome.ScreenSaver' '/org/gnome/ScreenSaver' org.gnome.ScreenSaver.GetActive)"
	if [ $? -eq 0 ]
	then
		echo "Checking screensaver via dbus-send run without errors (reply was \"$DBUS_REPLY\")."
		if echo $DBUS_REPLY | grep -q true
		then
			echo "The screen is now locked."
			break
		else
			echo "The screen is not locked yet..."
			continue
		fi
	else
		echo "Checking screensaver via dbus-send failed..."
		continue
	fi
do :; done

# virtual hammering the F2 key to work around the following bug:
# https://bugzilla.gnome.org/show_bug.cgi?id=710904
for i in 1 2 3
do
	xdotool key F2
	sleep 1
done
