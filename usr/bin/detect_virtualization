#!/bin/sh

if [ ! -e /etc/polkit-1/localauthority/50-local.d/10-welcome.pkla ] &&
   [ ! -e /etc/polkit-1/localauthority/55-lernstick-exam.d/10-welcome_strict.pkla ]
then
        # as long as the user didn't set a password we allow everything...
        exit 0
fi

# gettext support
. gettext.sh
export TEXTDOMAIN=detect_virtualization

VIRTUALIZATION="$(systemd-detect-virt)"

if [ "${VIRTUALIZATION}" != "none" ]
then
	TMP_FILE="/tmp/virtualization_lock.jpg"

        convert /usr/share/backgrounds/gnome/Fabric.jpg \
                -background black \
                -fill white \
                -pointsize 90 \
                -gravity South \
                -splice 0x220 \
                -annotate +0+20 "$(eval_gettext "Virtualization (\${VIRTUALIZATION}) detected\nLogin required")" \
                -append \
                "${TMP_FILE}"

	dconf write /org/gnome/desktop/screensaver/picture-uri "'file://${TMP_FILE}'"
	dconf write /org/gnome/desktop/screensaver/picture-options "'stretched'"
	dbus-send --type=method_call --dest=org.gnome.ScreenSaver /org/gnome/ScreenSaver org.gnome.ScreenSaver.Lock

	# https://bugzilla.gnome.org/show_bug.cgi?id=710904
	for i in 1 2 3 4 5
	do
		xdotool key F2
		sleep 1
	done
fi
