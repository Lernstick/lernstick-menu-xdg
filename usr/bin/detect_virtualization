#!/bin/sh

if [ ! -e /etc/polkit-1/localauthority/50-local.d/10-welcome.pkla ] &&
   [ ! -e /etc/polkit-1/localauthority/55-lernstick-exam.d/10-welcome_strict.pkla ] &&
   ! grep -q ShowPasswordDialog=false /etc/lernstickWelcome
then
        # as long as the user didn't set a password we allow everything...
	echo "The user didn't set a passwort yet. Exiting..."
        exit 0
fi

# gettext support
. gettext.sh
export TEXTDOMAIN=detect_virtualization

VIRTUALIZATION="$(systemd-detect-virt)"
if [ "${VIRTUALIZATION}" = "none" ]
then
	echo "No virtualization detected."
        exit 0
fi

echo "Virtualization \"${VIRTUALIZATION}\" detected. Locking screen..."

TMP_FILE="/tmp/virtualization_lock.jpg"
convert /usr/share/backgrounds/gnome/Wood.jpg \
	-background black \
	-fill white \
	-pointsize 90 \
	-gravity South \
	-splice 0x220 \
	-annotate +0+20 "$(eval_gettext "Virtualization (\${VIRTUALIZATION}) detected\nLogin required")" \
	-append \
	"${TMP_FILE}"

dconf write /org/gnome/desktop/screensaver/picture-uri "'file://${TMP_FILE}'"
dconf write /org/gnome/desktop/screensaver/picture-options "'stretched'"

# In Debian 10 XDG autostart applications are started too early, see:
# https://blogs.gnome.org/benzea/2019/10/01/gnome-3-34-is-now-managed-using-systemd/#comment-14161
# Therefore we have to sleep for some seconds to work around the bug above.
sleep 5
dbus-send --type=method_call --dest=org.gnome.ScreenSaver /org/gnome/ScreenSaver org.gnome.ScreenSaver.Lock

# virtual hammering the F2 key to work around the following bug:
# https://bugzilla.gnome.org/show_bug.cgi?id=710904
for i in 1 2 3 4 5
do
	xdotool key F2
	sleep 1
done
